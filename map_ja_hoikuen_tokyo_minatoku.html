<html>
    <head>
      <style>
        html, body, #map {
          width: 100%;
          height: 100%;
          margin: 0;
          padding: 0;
          background-color: #FFFFFF;
        }
        td {
          padding: 5px;
          font-size: 14px;
        }
        .section_title {
          min-width: 90px;
        }
      </style>
    </head>

    <body>
      <div
        id="map" 
        data-lat="35.65174"
        data-lng="139.74336"
        data-zoom="13"      
        data-marker="off"
        data-hash="on" 
        class="left"
      ></div>
      <script src="https://cdn.geolonia.com/v1/embed?geolonia-api-key=YOUR-API-KEY"></script>

      <script src="https://sdk.amazonaws.com/js/aws-sdk-2.775.0.min.js"></script>
      <script src="https://unpkg.com/@aws-amplify/core@3.7.0/dist/aws-amplify-core.min.js"></script>
      <script>
        // use Signer from @aws-amplify/core
        const { Signer } = window.aws_amplify_core;

        // configuration
        const identityPoolId = "ap-northeast-1:d995db2c-8646-4ed2-8122-45dbd2c80019"; // Cognito Identity Pool ID
        const mapName = "explore.map"; // Amazon Location Service Map Name

        // extract the region from the Identity Pool ID
        AWS.config.region = identityPoolId.split(":")[0];

        // instantiate a Cognito-backed credential provider
        const credentials = new AWS.CognitoIdentityCredentials({
          IdentityPoolId: identityPoolId,
        });

        /**
         * Sign requests made by Mapbox GL using AWS SigV4.
         */
        function transformRequest(url, resourceType) {
          if (resourceType === "Style" && !url.includes("://")) {
            // resolve to an AWS URL
            url = `https://maps.geo.${AWS.config.region}.amazonaws.com/maps/v0/maps/${url}/style-descriptor`;
          }

          if (url.includes("amazonaws.com")) {
            // only sign AWS requests (with the signature as part of the query string)
            const result = {
              url: Signer.signUrl(url, {
                access_key: credentials.accessKeyId,
                secret_key: credentials.secretAccessKey,
                session_token: credentials.sessionToken,
              }),
            };
            return result
          }

          // don't sign
          return { url };
        }

        /**
         * Initialize a map.
         */
        async function initializeMap() {
          // load credentials and set them up to refresh
          await credentials.getPromise();

          // actually initialize the map
          const map = new geolonia.Map({
            container: "#map",
            style: "./style-ja-hoikuen-tokyo-minatoku.json",
            transformRequest,
          });

          const popup = new geolonia.Popup({offset: 10, anchor: 'bottom', maxWidth: '260px'})

          map.on('load', () => {

            const openPopup = event => {
              
              const features = map.queryRenderedFeatures(event.point)
              const feature = features.find(({layer}) => layer.id === "points")

              console.log(feature)

              const name = feature.properties["保育園名"]
              const hoursStart = feature.properties["標準時間開始時間"]
              const hoursEnd = feature.properties["標準時間終了時間"]
              const age = feature.properties["入園可能月齢"]

              const table = `<table><tr><td class="section_title">名称</td><td>${name}</td></tr><tr><td class="section_title">標準時利用時間</td><td>${hoursStart}~${hoursEnd}</td></tr><tr><td class="section_title">入園可能月齢</td><td>${age}</td></tr></table>`

              popup
                .setHTML(table)
                .setLngLat(event.lngLat)
                .addTo(map);

            }

            const mouseEnter = () => {
              map.getCanvas().style.cursor = 'pointer'
            }

            const mouseLeave = () => {
              map.getCanvas().style.cursor = ''
            }

            map.on('click', 'points', openPopup)

            map.getStyle().layers.forEach( (item) => {
              map.on('mouseenter', item.id, mouseEnter)
              map.on('mouseleave', item.id, mouseLeave)
            })
          })
        }

        initializeMap();
      </script>
    </body>
  </html>
