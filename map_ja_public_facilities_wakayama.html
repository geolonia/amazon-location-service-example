<html>
    <head>
      <style>
        html, body {
          width: 100%;
          height: 100%;
          margin: 0;
          padding: 0;
          background-color: #555555;
        }
        .left {
          margin-right: 400px;
          height: 100%;
          background-color: #FFFFFF;
        }
        .right
        {
          margin-left: calc(100% - 400px);
          position: absolute;
          top: 0;
          padding: 8px 16px;
          height: calc(100% - 48px);
          width: calc(400px - 32px);
          overflow: scroll;
          color: #FFFFFF;
        }
      </style>
    </head>

    <body>
      <div
        id="map" 
        data-lat="33.9151"
        data-lng="135.5317"
        data-zoom="9"      
        data-marker="off"
        data-hash="on" 
        class="left"
      ></div>      <pre id="json" class="right"></pre>
      <script src="https://cdn.geolonia.com/v1/embed?geolonia-api-key=YOUR-API-KEY"></script>

      <script src="https://sdk.amazonaws.com/js/aws-sdk-2.775.0.min.js"></script>
      <script src="https://unpkg.com/@aws-amplify/core@3.7.0/dist/aws-amplify-core.min.js"></script>
      <script>
        // use Signer from @aws-amplify/core
        const { Signer } = window.aws_amplify_core;

        // configuration
        const identityPoolId = "ap-northeast-1:d995db2c-8646-4ed2-8122-45dbd2c80019"; // Cognito Identity Pool ID
        const mapName = "explore.map"; // Amazon Location Service Map Name

        // extract the region from the Identity Pool ID
        AWS.config.region = identityPoolId.split(":")[0];

        // instantiate a Cognito-backed credential provider
        const credentials = new AWS.CognitoIdentityCredentials({
          IdentityPoolId: identityPoolId,
        });

        /**
         * Sign requests made by Mapbox GL using AWS SigV4.
         */
        function transformRequest(url, resourceType) {
          if (resourceType === "Style" && !url.includes("://")) {
            // resolve to an AWS URL
            url = `https://maps.geo.${AWS.config.region}.amazonaws.com/maps/v0/maps/${url}/style-descriptor`;
          }

          if (url.includes("amazonaws.com")) {
            // only sign AWS requests (with the signature as part of the query string)
            const result = {
              url: Signer.signUrl(url, {
                access_key: credentials.accessKeyId,
                secret_key: credentials.secretAccessKey,
                session_token: credentials.sessionToken,
              }),
            };
            return result
          }

          // don't sign
          return { url };
        }

        /**
         * Initialize a map.
         */
        async function initializeMap() {
          // load credentials and set them up to refresh
          await credentials.getPromise();

          // actually initialize the map
          const map = new geolonia.Map({
            container: "#map",
            style: "./style-ja-public-facilities-wakayama.json",
            transformRequest,
          });

          map.on('load', () => {
            const dumpFeature = event => {
              const features = map.queryRenderedFeatures(event.point)
              const jsonContainer = document.getElementById('json')
              jsonContainer.innerText = JSON.stringify(features, null, '  ')
            }

            const mouseEnter = () => {
              map.getCanvas().style.cursor = 'pointer'
            }

            const mouseLeave = () => {
              map.getCanvas().style.cursor = ''
            }

            map.getStyle().layers.forEach( (item) => {
              map.on('click', item.id, dumpFeature)
              map.on('mouseenter', item.id, mouseEnter)
              map.on('mouseleave', item.id, mouseLeave)
            })
          })
        }

        initializeMap();
      </script>
    </body>
  </html>
